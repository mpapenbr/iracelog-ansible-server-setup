version: "3.3"

services:

  db:
    image: postgres:14
    restart: always
    # only used for development
    # ports:
    #   - 5432:5432
    volumes:
      - db-data:/var/lib/postgresql/data

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $POSTGRES_USER" ]
      interval: 5s
      timeout: 5s
      retries: 5

    logging:
      driver: "json-file"
      options:
        max-size: "2m"
        max-file: "5"

    environment:
      TZ: "Europe/Berlin"
      POSTGRES_DB: ${DB_SCHEMA}
      POSTGRES_USER: ${DB_USER_NAME}
      POSTGRES_PASSWORD: ${DB_USER_PASSWORD}

    networks:
      - somenet

  iwr:
    image: ghcr.io/mpapenbr/iracelog-wamp-router:v0.0.2
    restart: always
    networks:
      - somenet
      - traefiknet
    logging:
      driver: "json-file"
      options:
        max-size: "2m"
        max-file: "5"
    command: "server --logLevel info"
    environment:
      TZ: "Europe/Berlin"
      DATAPROVIDER_TICKET: ${CROSSBAR_DATAPROVIDER_TICKET}
      BACKEND_TICKET: ${CROSSBAR_BACKEND_TICKET}
      ADMIN_TICKET: ${CROSSBAR_ADMIN_TICKET}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.crossbar.rule=Host(`crossbar.{{ main_domain }}`)"
      - "traefik.http.routers.crossbar.entrypoints=websecure"
      - "traefik.http.routers.crossbar.tls=true"
      - "traefik.http.routers.crossbar.tls.certresolver=myresolver"
      - "traefik.http.routers.crossbar.middlewares=mp-headers@file"
      - "traefik.http.services.crossbar.loadbalancer.server.port=8080"
      - "traefik.docker.network=my_traefik_network"


  # iracelog-service-manager
  ism:
    image: ghcr.io/mpapenbr/iracelog-service-manager-go:v0.7.0

    networks:
      - somenet
    environment:
      TZ: "Europe/Berlin"
      ISM_URL: ${RACELOG_URL}
      ISM_REALM: ${RACELOG_REALM}
      ISM_USER: ${RACELOG_USER}
      ISM_PASSWORD: ${CROSSBAR_BACKEND_TICKET}
      ISM_DB: postgresql://${DB_USER_NAME}:${DB_USER_PASSWORD}@db:5432/iracelog
    command: "server"
    depends_on:
      - db
      - iwr

  db-migrate:
    image: ghcr.io/mpapenbr/iracelog-service-manager-go:v0.7.0

    networks:
      - somenet

    environment:
      TZ: "Europe/Berlin"
      ISM_URL: ${RACELOG_URL}
      ISM_REALM: ${RACELOG_REALM}
      ISM_USER: ${RACELOG_USER}
      ISM_PASSWORD: ${CROSSBAR_BACKEND_TICKET}
      ISM_DB: postgresql://${DB_USER_NAME}:${DB_USER_PASSWORD}@db:5432/iracelog
    command: "migrate"

    depends_on:
      - db
      - iwr

  # iracelog-analysis-service
  ias:
    image: ghcr.io/mpapenbr/iracelog-analysis-service:{{ iracelog_ias_version }}
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "2m"
        max-file: "5"
    networks:
      - somenet

    environment:
      TZ: "Europe/Berlin"
      CROSSBAR_URL: ${RACELOG_URL}
      CROSSBAR_REALM: ${RACELOG_REALM}
      CROSSBAR_USER: ${RACELOG_USER}
      CROSSBAR_CREDENTIALS: ${CROSSBAR_BACKEND_TICKET}
      DB_URL: postgresql://${DB_USER_NAME}:${DB_USER_PASSWORD}@db:5432/iracelog

    depends_on:
      - db
      - iwr


  # the frontend
  iracelog:
    image: ghcr.io/mpapenbr/iracelog-web:{{ iracelog_frontend_version }}
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "2m"
        max-file: "5"
    networks:
      - somenet
      - traefiknet


    environment:
      TZ: "Europe/Berlin"
    volumes:
      - ./config/iracelog/frontend.json:/usr/share/nginx/html/config.json

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`iracelog.{{ main_domain }}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.routers.frontend.tls.certresolver=myresolver"
      - "traefik.http.routers.frontend.middlewares=mp-headers@file,compress-content@file"
      - "traefik.docker.network=my_traefik_network"
  
  # the graphql api
  graphql:
    image: ghcr.io/mpapenbr/iracelog-graphql:{{ iracelog_graphql_version }}
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "2m"
        max-file: "5"
    networks:
      - somenet
      - traefiknet

    depends_on:
      - db

    environment:
      TZ: "Europe/Berlin"
      DATABASE_URL: postgresql://${DB_USER_NAME}:${DB_USER_PASSWORD}@db:5432/iracelog


    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.graphql.rule=Host(`graphql.{{ main_domain }}`)"
      - "traefik.http.routers.graphql.entrypoints=websecure"
      - "traefik.http.routers.graphql.tls=true"
      - "traefik.http.routers.graphql.tls.certresolver=myresolver"
      - "traefik.http.routers.graphql.middlewares=mp-headers@file,compress-content@file"
      - "traefik.docker.network=my_traefik_network"

  main-services:
    image: busybox
    command: sh -c "echo Starting services"
    depends_on:
      - db
      - iwr
      - ism      
      - ias
      - iracelog
      - graphql


volumes:
  db-data:
  backup:



networks:
  somenet:
  traefiknet:
    external:
      name: my_traefik_network



